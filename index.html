<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ef6d4f">
    <meta name="description" content="SOS Daily Practice Platform">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://play-lh.googleusercontent.com/ZvXwylZYLMWrhTbpMKpehJWBhg9VcHoiovOHh4oRA3dU_e9tQp0gYRzkRp29QkAxhI4=w240-h480-rw">
    
    <title>SOS Daily Practice</title>

    <!-- 1. Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        tempo: {
                            red: '#f46d6d',
                            blue: '#88a2b2',
                            yellow: '#ffeda0',
                            purple: '#485484',
                            orange: '#ef6d4f',
                            gold: '#c6a777',
                            dark: '#1a1a1a',
                            light: '#f8f9fa',
                            // Dark mode specific palettes
                            darkbg: '#09090b', 
                            darkcard: '#18181b',
                            darkinput: '#27272a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- 3. React & ReactDOM & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* Base styles with dark mode support */
        body { @apply bg-zinc-50 text-zinc-900 dark:bg-tempo-darkbg dark:text-white transition-colors duration-300; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #999; }
        .dark ::-webkit-scrollbar-thumb { background: #444; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Star Rating Fill Logic */
        .star-filled { fill: currentColor; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyDkXOuZGZ_vMQJPAIFe3ujRAoiN3BLFhoQ",
            authDomain: "os-daily-practice-data.firebaseapp.com",
            projectId: "os-daily-practice-data",
            storageBucket: "os-daily-practice-data.firebasestorage.app",
            messagingSenderId: "854911444720",
            appId: "1:854911444720:web:1406bd3843a3082a3fc435",
            measurementId: "G-47TJTYBX20"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const ADMIN_EMAILS = [
            'ahmed.hamed@tempo.fit',
            'fatma.mohammad@tempo.fit',
            'hebasobky@tempo.fit',
            'khaledsabban@tempo.fit'
        ];

        const EMOJIS = [
            "ðŸ‘", "ðŸ‘Ž", "â¤ï¸", "ðŸ”¥", "âœ…", "âŒ", "ðŸŽ‰", "ðŸ¤”", "ðŸ‘€", "ðŸ’ª", 
            "ðŸ‘‹", "ðŸ™Œ", "ðŸ‘", "ðŸ¤", "ðŸš€", "ðŸ’¡", "â­", "ðŸ†", "ðŸ’¯", "âœ¨",
            "ðŸ˜Š", "ðŸ˜‚", "ðŸ˜Ž", "ðŸ˜¢", "ðŸ˜¡", "ðŸ¤¯", "ðŸ˜±", "ðŸ¤—", "ðŸ¤«", "ðŸ«¡",
            "ðŸ‹ï¸", "ðŸ§˜", "ðŸš´", "ðŸ¤¸", "ðŸƒ", "ðŸ“ž", "ðŸ’»", "ðŸ“±", "ðŸ“§", "ðŸ’¬"
        ];

        // --- CONSTANTS ---
        const MODES = {
            SMS: { 
                id: 'sms', label: 'Daily SMS', 
                iconName: 'message-square', 
                color: 'text-tempo-orange', bg: 'bg-tempo-orange', border: 'border-tempo-orange',
                lightBg: 'bg-orange-50 dark:bg-orange-900/10',
                persona: 'Coach Melissa' 
            },
            QUIZ: { 
                id: 'quiz', label: 'Weekly Quiz', 
                iconName: 'trophy', 
                color: 'text-tempo-purple', bg: 'bg-tempo-purple', border: 'border-tempo-purple',
                lightBg: 'bg-indigo-50 dark:bg-indigo-900/20',
                persona: 'Sales Expert' 
            }
        };

        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.seconds) return 'Just now';
            return new Date(timestamp.seconds * 1000).toLocaleDateString() + ' ' + 
                   new Date(timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        const getManagerName = (email) => {
            if (!email) return 'Manager';
            const lower = email.toLowerCase();
            if (lower.includes('ahmed.hamed')) return 'Hamad';
            if (lower.includes('fatma')) return 'Fatma';
            if (lower.includes('heba')) return 'Heba';
            if (lower.includes('khaled')) return 'Khaled';
            return email.split('@')[0]; 
        };

        const getRatingLabel = (score) => {
            if (score === 5) return "Perfect Response!";
            if (score === 3 || score === 4) return "Good Response!";
            if (score === 1 || score === 2) return "You Can Do Better!";
            return "";
        };
        
        const getRatingColorClass = (score) => {
            if (score === 5) return "text-green-600 dark:text-green-400";
            if (score >= 3) return "text-tempo-blue dark:text-blue-300";
            return "text-tempo-red dark:text-red-400";
        }

        // --- COMPONENTS ---

        const Icon = ({ name, className, filled }) => {
            const iconRef = useRef(null);
            useEffect(() => {
               if(iconRef.current && window.lucide) {
                   iconRef.current.innerHTML = '';
                   const i = document.createElement('i');
                   i.setAttribute('data-lucide', name);
                   if(className) i.className = className;
                   if(filled) i.setAttribute('fill', 'currentColor');
                   iconRef.current.appendChild(i);
                   window.lucide.createIcons({ root: iconRef.current, nameAttr: 'data-lucide', attrs: { class: className, fill: filled ? 'currentColor' : 'none' } });
               }
            }, [name, className, filled]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" style={{lineHeight: 0}} />;
        };

        const NotificationBadge = ({ count, modeBgClass }) => {
            if (count === 0) return null;
            return (
                <span className={`absolute -top-1 -right-2 ${modeBgClass} text-white text-[10px] font-extrabold px-1.5 py-0.5 rounded-full shadow-sm border border-white dark:border-zinc-800`}>
                    {count}
                </span>
            );
        };

        const StarRating = ({ rating, onRate, readonly = false }) => {
            return (
                <div className="flex items-center gap-2">
                    <div className="flex items-center gap-1">
                        {[1, 2, 3, 4, 5].map((star) => (
                            <button 
                                key={star}
                                type="button"
                                disabled={readonly}
                                onClick={() => !readonly && onRate(star)}
                                className={`focus:outline-none transition-transform ${readonly ? 'cursor-default' : 'cursor-pointer hover:scale-110'}`}
                                title={readonly ? `Score: ${rating}/5` : `Rate ${star} Stars`}
                            >
                                <Icon 
                                    name="star" 
                                    className={`w-5 h-5 ${star <= rating ? 'text-tempo-yellow' : 'text-zinc-300 dark:text-zinc-600'}`} 
                                    filled={star <= rating}
                                />
                            </button>
                        ))}
                    </div>
                    {rating > 0 && (
                        <span className={`text-[10px] font-bold uppercase tracking-wider ${getRatingColorClass(rating)}`}>
                            {getRatingLabel(rating)}
                        </span>
                    )}
                </div>
            );
        };

        const MarkdownText = ({ text }) => {
            if (!text) return null;
            const parts = text.split(/(\*\*.*?\*\*|\*.*?\*|\[.*?\]\(.*?\))/g);
            return (
                <span>
                    {parts.map((part, i) => {
                        if (part.startsWith('**') && part.endsWith('**')) {
                            return <strong key={i} className="font-extrabold text-tempo-purple dark:text-tempo-yellow">{part.slice(2, -2)}</strong>;
                        }
                        if (part.startsWith('*') && part.endsWith('*')) {
                            return <em key={i} className="italic text-tempo-purple dark:text-tempo-yellow">{part.slice(1, -1)}</em>;
                        }
                        if (part.startsWith('[') && part.includes('](') && part.endsWith(')')) {
                            const match = part.match(/\[(.*?)\]\((.*?)\)/);
                            if (match) {
                                return <a key={i} href={match[2]} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:text-blue-600 dark:text-blue-400 underline decoration-dotted underline-offset-4">{match[1]}</a>;
                            }
                        }
                        return part;
                    })}
                </span>
            );
        };

        const RichTextEditor = ({ value, onChange, placeholder }) => {
            const textareaRef = useRef(null);
            const [showEmoji, setShowEmoji] = useState(false);

            const insertFormat = (tag) => {
                const textarea = textareaRef.current;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                let newText;
                let newCursorPos;

                if (tag === 'link') {
                    const url = prompt("Enter URL:");
                    if (!url) return;
                    const selected = text.slice(start, end) || "link";
                    const insert = `[${selected}](${url})`;
                    newText = text.slice(0, start) + insert + text.slice(end);
                    newCursorPos = start + insert.length;
                } else if (tag.length === 1 || tag.length === 2) { 
                     newText = text.slice(0, start) + tag + text.slice(end);
                     newCursorPos = start + tag.length;
                } else {
                    const wrapper = tag === 'bold' ? '**' : '*';
                    const selectedText = text.slice(start, end);
                    newText = text.slice(0, start) + wrapper + selectedText + wrapper + text.slice(end);
                    newCursorPos = end + (wrapper.length * 2);
                }

                onChange(newText);
                setTimeout(() => {
                    textarea.focus();
                    textarea.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            };

            return (
                <div className="border border-zinc-300 dark:border-zinc-700 rounded-xl overflow-hidden bg-white dark:bg-tempo-darkinput focus-within:ring-2 focus-within:ring-tempo-blue transition-shadow relative">
                    <div className="flex items-center gap-1 bg-zinc-50 dark:bg-zinc-800 border-b border-zinc-200 dark:border-zinc-700 px-2 py-1.5">
                        <button type="button" onClick={() => insertFormat('bold')} className="p-1.5 hover:bg-zinc-200 dark:hover:bg-zinc-700 rounded text-zinc-700 dark:text-zinc-300 font-bold" title="Bold"><span className="font-serif">B</span></button>
                        <button type="button" onClick={() => insertFormat('italic')} className="p-1.5 hover:bg-zinc-200 dark:hover:bg-zinc-700 rounded text-zinc-700 dark:text-zinc-300 italic" title="Italic"><span className="font-serif">I</span></button>
                         <button type="button" onClick={() => insertFormat('link')} className="p-1.5 hover:bg-zinc-200 dark:hover:bg-zinc-700 rounded text-zinc-700 dark:text-zinc-300" title="Link"><Icon name="link" className="w-4 h-4" /></button>
                        <div className="w-px h-4 bg-zinc-300 dark:bg-zinc-600 mx-1"></div>
                        <div className="relative">
                            <button type="button" onClick={() => setShowEmoji(!showEmoji)} className="p-1.5 hover:bg-zinc-200 dark:hover:bg-zinc-700 rounded text-zinc-700 dark:text-zinc-300" title="Insert Emoji"><Icon name="smile" className="w-4 h-4" /></button>
                            {showEmoji && (
                                <>
                                    <div className="fixed inset-0 z-10" onClick={() => setShowEmoji(false)}></div>
                                    <div className="absolute top-8 left-0 z-20 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg shadow-xl p-2 w-64 grid grid-cols-8 gap-1 max-h-48 overflow-y-auto">
                                        {EMOJIS.map(emoji => (
                                            <button key={emoji} type="button" onClick={() => { insertFormat(emoji); setShowEmoji(false); }} className="p-1 hover:bg-zinc-100 dark:hover:bg-zinc-700 rounded text-lg flex items-center justify-center">{emoji}</button>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                    <textarea ref={textareaRef} className="w-full p-4 outline-none text-sm min-h-[120px] bg-transparent text-zinc-950 dark:text-zinc-100 resize-y font-sans placeholder-zinc-500 dark:placeholder-zinc-500" placeholder={placeholder} value={value} onChange={(e) => onChange(e.target.value)} />
                </div>
            );
        };

        const CommentsSection = ({ responseId, comments, onAddComment, onEditComment, onDeleteComment, currentUser }) => {
            const [newComment, setNewComment] = useState('');
            const [editingIndex, setEditingIndex] = useState(null);
            const [editText, setEditText] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSend = async (e) => {
                e.preventDefault();
                if(!newComment.trim()) return;
                setIsSubmitting(true);
                await onAddComment(responseId, newComment);
                setNewComment('');
                setIsSubmitting(false);
            };

            const startEdit = (index, text) => {
                setEditingIndex(index);
                setEditText(text);
            };

            const saveEdit = async (index) => {
                if (!editText.trim()) return;
                await onEditComment(responseId, index, editText);
                setEditingIndex(null);
                setEditText('');
            };

            return (
                <div className="mt-4 border-t border-zinc-200 dark:border-zinc-700 pt-4">
                    <h4 className="text-xs font-bold uppercase text-zinc-500 dark:text-zinc-400 mb-3 flex items-center gap-2">
                        <Icon name="message-circle" className="w-3 h-3" /> Discussion
                    </h4>
                    <div className="space-y-3 mb-4">
                        {(!comments || comments.length === 0) && (
                            <p className="text-xs text-zinc-500 dark:text-zinc-400 italic">No questions or comments yet.</p>
                        )}
                        {comments && comments.map((c, i) => (
                            <div key={i} className={`flex flex-col ${c.email === currentUser.email ? 'items-end' : 'items-start'}`}>
                                {editingIndex === i ? (
                                    <div className="w-full max-w-[85%]">
                                        <RichTextEditor value={editText} onChange={setEditText} />
                                        <div className="flex justify-end gap-2 mt-2">
                                            <button onClick={() => setEditingIndex(null)} className="text-xs text-zinc-500 hover:text-zinc-700">Cancel</button>
                                            <button onClick={() => saveEdit(i)} className="text-xs bg-tempo-purple text-white px-3 py-1 rounded-md">Save</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className={`max-w-[85%] rounded-xl px-3 py-2 text-sm relative group ${c.email === currentUser.email ? 'bg-tempo-blue/20 text-tempo-purple dark:text-white' : 'bg-zinc-100 dark:bg-zinc-800 text-zinc-900 dark:text-zinc-300'}`}>
                                        <div className="text-[10px] font-bold opacity-75 mb-0.5 flex justify-between items-center">
                                            <span>{c.author}</span>
                                            {c.email === currentUser.email && (
                                                <div className="flex gap-2 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => startEdit(i, c.text)} title="Edit" className="hover:text-tempo-orange"><Icon name="pencil" className="w-3 h-3" /></button>
                                                    <button onClick={() => onDeleteComment(responseId, i)} title="Delete" className="hover:text-tempo-red"><Icon name="trash-2" className="w-3 h-3" /></button>
                                                </div>
                                            )}
                                        </div>
                                        <MarkdownText text={c.text} />
                                    </div>
                                )}
                                <span className="text-[10px] text-zinc-500 dark:text-zinc-400 mt-1 px-1">{formatDate(c.timestamp)}</span>
                            </div>
                        ))}
                    </div>
                    <form onSubmit={handleSend} className="flex gap-2 items-end">
                        <div className="flex-1">
                            <RichTextEditor value={newComment} onChange={setNewComment} placeholder="Ask a question or reply..." />
                        </div>
                        <button type="submit" disabled={!newComment.trim() || isSubmitting} className="bg-tempo-purple text-white p-3 rounded-xl hover:opacity-90 disabled:opacity-50 transition-all h-[48px] flex items-center justify-center">
                            <Icon name="send" className="w-4 h-4" />
                        </button>
                    </form>
                </div>
            );
        };

        const Header = ({ theme, toggleTheme, userRole, currentUser, onSignOut, notificationCount }) => {
            return (
                <header className="sticky top-0 z-50 w-full bg-white/90 dark:bg-tempo-darkcard/90 backdrop-blur-md border-b border-zinc-200 dark:border-zinc-800 shadow-sm transition-colors duration-300">
                    <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="bg-tempo-orange p-1.5 rounded-lg shadow-sm">
                                <Icon name="shield" className="text-white w-6 h-6" />
                            </div>
                            <span className="font-bold text-xl tracking-tight text-tempo-purple dark:text-white">
                                SOS <span className="text-tempo-orange">DAILY PRACTICE</span>
                            </span>
                        </div>
                        <div className="flex items-center gap-4">
                             <button onClick={toggleTheme} className="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-700 dark:text-zinc-400 transition-colors" title="Toggle Dark Mode">
                                {theme === 'dark' ? <Icon name="sun" className="w-5 h-5" /> : <Icon name="moon" className="w-5 h-5" />}
                            </button>
                            
                            {/* NOTIFICATION BELL FOR AGENTS */}
                            {userRole === 'agent' && (
                                <div className="relative">
                                    <div className="p-2 text-zinc-600 dark:text-zinc-300">
                                        <Icon name="bell" className="w-5 h-5" />
                                    </div>
                                    {notificationCount > 0 && (
                                        <span className="absolute top-0 right-0 bg-tempo-red text-white text-[9px] font-extrabold px-1.5 py-0.5 rounded-full shadow-sm">
                                            {notificationCount}
                                        </span>
                                    )}
                                </div>
                            )}

                            {currentUser && (
                                <div className="flex items-center gap-3 pl-4 border-l border-zinc-200 dark:border-zinc-700">
                                    <div className="flex flex-col items-end mr-1 hidden sm:flex">
                                        <span className="text-xs font-bold text-tempo-purple dark:text-zinc-300">{currentUser.displayName || 'Agent'}</span>
                                    </div>
                                    <div className="w-9 h-9 rounded-full bg-tempo-purple text-tempo-yellow flex items-center justify-center text-sm font-bold shadow-sm border-2 border-white dark:border-zinc-800" title={currentUser.email}>
                                        {currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : 'A'}
                                    </div>
                                    <button onClick={onSignOut} className="text-zinc-400 hover:text-tempo-red transition-colors" title="Sign Out">
                                        <Icon name="log-out" className="w-5 h-5" />
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </header>
            );
        };

        const LoginScreen = ({ onSignIn, onSignUp, theme, toggleTheme }) => {
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);
                setLoading(true);
                try {
                    if (isSignUp) {
                        await onSignUp(email, password, name);
                    } else {
                        await onSignIn(email, password);
                    }
                } catch (err) {
                    console.error(err);
                    let msg = err.message;
                    if (err.code === 'auth/configuration-not-found') msg = "Setup Error: Enable 'Email/Password' in Firebase Console > Authentication.";
                    else if (err.code === 'auth/email-already-in-use') msg = "Email already registered.";
                    else if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') msg = "Invalid email or password.";
                    else if (err.code === 'auth/weak-password') msg = "Password too short (min 6 chars).";
                    setError(msg);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 dark:from-zinc-900 dark:to-black p-4 font-sans transition-colors duration-300 relative">
                    <div className="absolute top-4 right-4">
                         <button onClick={toggleTheme} className="p-3 rounded-full bg-white dark:bg-zinc-800 shadow-md hover:bg-zinc-100 dark:hover:bg-zinc
